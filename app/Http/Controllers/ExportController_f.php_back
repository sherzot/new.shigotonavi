<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Exports\CustomExport;
use Maatwebsite\Excel\Facades\Excel;
use App\Models\User;
use Symfony\Component\HttpFoundation\BinaryFileResponse;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Barryvdh\DomPDF\Facade\Pdf;
use GuzzleHttp\Client;
//use App\Exports\CustomExport;
//use Maatwebsite\Excel\Facades\Excel;

class ExportController extends Controller
{
        public function export()
        {
                $person = Auth::user();
                if (!$person) {
                        return redirect()->route('login')->withErrors('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }

                $staffCode = Auth::user()->staff_code; //
                $users = DB::table('master_person')
                        ->select('staff_code', 'name', 'mail_address')
                        ->where('staff_code', $staffCode)
                        //->limit(1)
                        ->get();
                if (!$users) {
                        //errorå‡¦ç†
                        return back()->with('error', 'ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }

                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿ï¼‰
                $export = new CustomExport($users);
                $export->registerEVents();
                //dd($export);
                //dd(storage_path('app/exports/custom_export.xlsx'));
                //app/private/exports/custom_export.xls
                //Excel::store($export, 'private/exports/custom_export.xlsx');
                //Excel::store($export, storage_path('app/exports/custom_export.xlsx'));
                $filePath = 'exports/resume-' . $staffCode . '.xlsx';

                // Faylni yaratishdan oldin log yozish
                Log::info("Save file: " . storage_path('app/' . $filePath));

                Excel::store($export, $filePath, 'local');

                // Fayl mavjudligini logga yozish
                if (!\Storage::disk('local')->exists($filePath)) {
                        Log::error("File not created: " . $filePath);
                        return back()->with('error', 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }

                Log::info("File created successfully.: " . storage_path('app/' . $filePath));

                return response()->download(storage_path('app/' . $filePath));

                //return response()->download(storage_path('app/exports/custom_export.xlsx'));
                //return Excel::download(new CustomExport(), 'custom_export.xlsx');Excel::store($export, 'exports/custom_export.xlsx');
        }

        public function pdf()
        {
                $staffCode = Auth::user()->staff_code;
                $users = DB::table('master_person')
                        ->select('staff_code',        'name',        'mail_address')
                        ->where('staff_code',        $staffCode)
                        //->limit(1)
                        ->get();
                if (!$users) {
                        //errorå‡¦ç†
                        return back()->with('error', 'ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }

                $file_name = 'resume-' . $staffCode; //20250213
                //$file_name = 'custom_export';
                //$file_name = 'resume_' . date('YmdHis');
                //$export_service = new ExportService();
                //$export_service->makePdf($file_name);
                $export = new CustomExport();
                //dd($export);
                $export->makePdf($file_name);
                //dd($file_name); 
                $file_path = storage_path('app/exports/pdf/' . $file_name . '.pdf');
                if (!file_exists($file_path)) {
                        //dd($file_path . 'ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
                }
                //dd($file_path);
                $headers = ['Content-Type' => 'application/pdf'];
                return response()->download($file_path, $file_name . '.pdf', $headers);
        }

        public function careersheet()
        {
                $staffCode = Auth::user()->staff_code; //

                $users = DB::table('master_person')
                        ->select('staff_code', 'name', 'mail_address')
                        ->where('staff_code', $staffCode)
                        //->limit(10)
                        ->get();
                if (!$users) {
                        //errorå‡¦ç†
                        return        back()->with('error',        'ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„
ã€‚');
                }


                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿ï¼‰
                $export = new CustomExport($users);
                //export classã® makeCareerSheeté–¢æ•°ã‚’å‘¼ã³å‡ºã™
                $file_name = 'careersheet-' . $staffCode . '.xlsx';
                $export->makeCareerSheet($file_name);
                //Excel::store($export, 'exports/resume_test.xlsx');
                //dd($export);
                //dd(storage_path('app/exports/custom_export.xlsx'));
                Excel::store($export, 'exports/careersheet-' . $staffCode . '.xlsx');

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
                return response()->download(storage_path('app/exports/careersheet-' . $staffCode . '.xlsx')); //20250218
        }

        public function careerpdf()
        {
                $staffCode = Auth::user()->staff_code; //
                $users        =        DB::table('master_person')
                        ->select('staff_code',        'name',        'mail_address')
                        ->where('staff_code',        $staffCode)
                        //->limit(1)
                        ->get();
                if (!$users) {
                        //errorå‡¦ç†
                        return        back()->with('error',        'ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„
ã€‚');
                }

                $file_name = 'careersheet-' . $staffCode; //20250219
                $export = new CustomExport();
                //dd($export);
                $export->makeCareerPdf($file_name);
                //dd($file_name);
                $file_path = storage_path('app/exports/pdf/' . $file_name . '.pdf');
                //dd($file_path);
                $headers = ['Content-Type' => 'application/pdf'];
                return response()->download($file_path, $file_name . '.pdf', $headers);
        }

        public function generateResumeFiles($staffCode)
        {
                $users = DB::table('master_person')
                        ->select('staff_code', 'name', 'mail_address')
                        ->where('staff_code', $staffCode)
                        ->get();

                if ($users->isEmpty()) {
                        Log::error("ã€å±¥æ­´æ›¸ã‚¨ãƒ©ãƒ¼ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: StaffCode={$staffCode}");
                        return false;
                }

                // Fayl yoâ€˜llari
                $resumeFilePath = "exports/resume-{$staffCode}.xlsx";
                $careerSheetFilePath = "exports/careersheet-{$staffCode}.xlsx";

                try {
                        // å±¥æ­´æ›¸ (Resume) yaratish
                        $resumeExport = new CustomExport();
                        $resumeExport->registerEVents();
                        Excel::store($resumeExport, $resumeFilePath, 'local');
                        Log::info("ã€å±¥æ­´æ›¸ã€‘Excel ä½œæˆ: {$resumeFilePath}");
                } catch (\Exception $e) {
                        Log::error("ã€å±¥æ­´æ›¸ã‚¨ãƒ©ãƒ¼ã€‘Excel ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " . $e->getMessage());
                        return false;
                }

                try {
                        // è·å‹™çµŒæ­´æ›¸ (Career Sheet) yaratish
                        $careerSheetExport = new CustomExport();
                        $careerSheetExport->makeCareerSheet("careersheet-{$staffCode}");
                        Excel::store($careerSheetExport, $careerSheetFilePath, 'local');
                        Log::info("ã€è·å‹™çµŒæ­´æ›¸ã€‘Excel ä½œæˆ: {$careerSheetFilePath}");
                } catch (\Exception $e) {
                        Log::error("ã€è·å‹™çµŒæ­´æ›¸ã‚¨ãƒ©ãƒ¼ã€‘Excel ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " . $e->getMessage());
                        return false;
                }

                return [
                        'resume' => $resumeFilePath,
                        'careersheet' => $careerSheetFilePath
                ];
        }
        public function generateResumePDF($staffCode)
        {
                // âœ… 1ï¸âƒ£ Foydalanuvchi maâ€™lumotlarini olish
                $person = DB::table('master_person')->where('staff_code', $staffCode)->first();

                if (!$person) {
                        Log::error("ã€å±¥æ­´æ›¸ã‚¨ãƒ©ãƒ¼ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: StaffCode={$staffCode}");
                        return false;
                }

                // âœ… 2ï¸âƒ£ Taâ€™lim va ish tarixi maâ€™lumotlarini olish
                $educations = DB::table('person_educate_history')->where('staff_code', $staffCode)->get();
                $careers = DB::table('person_career_history')->where('staff_code', $staffCode)->get();

                // ðŸ“Œ Fayl yoâ€˜llari
                $resumeFilePath = "public/exports/resume-{$staffCode}.pdf";
                $careerSheetFilePath = "public/exports/careersheet-{$staffCode}.pdf";

                try {
                        // âœ… 3ï¸âƒ£ Resume PDF yaratish
                        $resumePdf = Pdf::loadView('pdf.resume', compact('person', 'educations', 'careers'))->setPaper('A4', 'portrait');
                        \Storage::put($resumeFilePath, $resumePdf->output());
                        Log::info("ã€å±¥æ­´æ›¸ã€‘PDF ä½œæˆ: {$resumeFilePath}");

                        // âœ… 4ï¸âƒ£ Career Sheet PDF yaratish
                        $careerPdf = Pdf::loadView('pdf.career', compact('person', 'educations', 'careers'))->setPaper('A4', 'portrait');
                        \Storage::put($careerSheetFilePath, $careerPdf->output());
                        Log::info("ã€è·å‹™çµŒæ­´æ›¸ã€‘PDF ä½œæˆ: {$careerSheetFilePath}");
                } catch (\Exception $e) {
                        Log::error("ã€å±¥æ­´æ›¸ã‚¨ãƒ©ãƒ¼ã€‘PDF ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " . $e->getMessage());
                        return false;
                }

                return [
                        'resume' => str_replace("public/", "", $resumeFilePath),
                        'careersheet' => str_replace("public/", "", $careerSheetFilePath)
                ];
                public function sendPdfToApi()
        {

                $staffCode = Auth::user()->staff_code;
                $users = DB::table('master_person')
                        ->select('staff_code',  'name', 'mail_address')
                        ->where('staff_code', $staffCode)
                        ->get();
                if (!$users) {
                        //errorå‡¦ç†
                        return back()->with('error', 'ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã 
ã•ã„ã€‚');
                }

                $file_name = 'resume-' . $staffCode; //20250213
                $export = new CustomExport();
                //dd($export);
                $export->makePdf($file_name);
                //dd($file_name);
                $file_path = storage_path('app/exports/pdf/' . $file_name . '.pdf');
                if (!file_exists($file_path)) {
                        //dd($file_path . 'ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
                }
                //dd($file_path);
        try {
	        // APIã«é€ä¿¡
	        $client = new Client();
		//Test api-s //Unyou https://api.printing.ne.jp .....
        	$response = $client->request('POST', 'https://api-S.printing.ne.jp/usr/webservice/api/', [
	            'multipart' => [
        	        [
	                    'name'     => 'file',
        	            'contents' => fopen($$file_path, 'r'),
                	    'filename' => 'resume-' .$staffCode .'.pdf'
	                ],
        	        [
                	    'name'     => 'other_param',
	                    'contents' => 'some_value'
        	        ]
	            ],
        	    'headers' => [
	                'Authorization' => 'Bearer YOUR_ACCESS_TOKEN'
        	    ]
	        ]);

        	$result = json_decode($response->getBody(), true);

	        return response()->json(['success' => true, 'response' => $result]);

        } catch (\Exception $e) {
    	    return response()->json(['error' => $e->getMessage()], 500);
        }


	}//end function


} //End of class
